(()=>{const t=async(t,e={})=>{const n=await new Promise((t,e)=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{chrome.runtime.lastError?e(chrome.runtime.lastError):n&&n.length?t(n[0]):e(new Error("No active tab"))})});return new Promise((a,s)=>{chrome.tabs.sendMessage(n.id,{type:"MAGIC_BUYER_PAGE_COMMAND",payload:{command:t,args:e},id:`${Date.now()}-${Math.random()}`},t=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t?t.success?a(t.payload):s(new Error(t.error||"Command failed")):s(new Error("No response from content script"))})})},e=document.getElementById("status"),n=document.getElementById("logs"),a=document.getElementById("error"),s=document.getElementById("settings-categories"),o=document.getElementById("settings-filters"),r=document.getElementById("settings-note"),i=document.querySelector(".settings-strip"),c=document.getElementById("settings-toggle");let d=!1;c&&c.addEventListener("click",()=>{var t;d=t=!d,i&&(i.hidden=!t),r&&(r.hidden=!t||!r.textContent),c&&(c.setAttribute("aria-expanded",String(t)),c.textContent=t?"Hide Settings":"Settings"),t&&p()});const l=t=>{if(!t)return a.textContent="",void(a.hidden=!0);a.textContent=t,a.hidden=!1},u=async()=>{try{const n=await t("getStatus"),a=[["State",n.statusText||"Unknown"],["Requests",n.requestCount||"0"],["Coins",n.coins||"0"],["Profit",n.profit||"0"],["Won",n.won||"0"],["Sold",n.sold||"0"],["Unsold",n.unsold||"0"],["Available",n.available||"0"],["Active transfers",n.activeTransfers||"0"],["Countdown",n.countdown||"00:00:00"]];e.innerHTML=a.map(([t,e])=>`<div><strong>${t}:</strong> ${e}</div>`).join(""),l("")}catch(t){e.innerHTML="",l(t?.message||"Unable to fetch status")}},m=async()=>{try{const{html:e}=await t("getLogs");n.innerHTML=`<ul>${e||""}</ul>`}catch(t){n.innerHTML="<em>Unable to load logs.</em>",l(t?.message||"Unable to load logs")}},g=(t,e,n,a,s={})=>{if(!t)return;if(!e||!e.length)return void(t.innerHTML="<span class='chip empty'>No data</span>");const{type:o}=s;t.innerHTML=e.map(t=>{const e="number"==typeof t.index?t.index:void 0,s=t.label||t,r="number"==typeof n&&"number"==typeof e&&e===n||"string"==typeof n&&s===n,i=a?.has?.(s),c=["chip"];r?c.push("active"):i&&c.push("selected");const d=[];"number"==typeof e&&d.push(`data-index="${e}"`),s&&d.push(`data-label="${s}"`),o&&d.push(`data-type="${o}"`);const l=d.length?` ${d.join(" ")}`:"";return`<button type="button" class="${c.join(" ")}"${l}>${s}</button>`}).join("")},p=async(e=!1)=>{if(s&&o&&d)try{const e=await t("getSettingsSummary"),n=e?.categories||[],a=e?.filters||[],i=e?.activeCategoryIndex??0,c=e?.activeFilter||"",d=new Set(e?.selectedFilters||[]);c&&d.add(c),g(s,n,i,void 0,{type:"category"}),g(o,a,c,d,{type:"filter"}),r&&(r.textContent="",r.hidden=!0)}catch(t){console.warn("MagicBuyer popup: unable to load settings summary",t),g(s,[],0),g(o,[],0),r&&(e?(r.textContent="",r.hidden=!0):(r.textContent="Open the MagicBuyer tab in the Ultimate Team web app to load settings and filters.",r.hidden=!1))}},y=(t,e)=>{const n=document.getElementById(t);var a;n&&n.addEventListener("click",(a=e,async()=>{try{await a(),l(""),await u(),await m(),await p(!0)}catch(t){l(t?.message||"Action failed")}}))};y("open",()=>t("open")),y("start",()=>t("start")),y("resume",()=>t("resume")),y("pause",()=>t("pause")),y("stop",()=>t("stop")),y("clear",()=>t("clearLogs")),u(),m(),setInterval(()=>{u(),m(),p(!0)},5e3);const h=async e=>{const n=e.target.closest(".chip[data-type='category']");if(!n)return;if(n.classList.contains("active"))return;const a=Number(n.dataset.index);if(!Number.isNaN(a)){n.disabled=!0;try{await t("setActiveSettingsTab",{index:a}),await p(!0),l("")}catch(t){l(t?.message||"Unable to activate settings")}finally{n.disabled=!1}}};s&&s.addEventListener("click",h)})();